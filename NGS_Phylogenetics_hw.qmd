---
engine: knitr
---


# Выполнение домашнего задания по филогенетике

**Сравнительная филогеография кошачьих Индии: повторный анализ данных**

**Цель работы:** воспроизвести филогенетический анализ из статьи Mukherjee et al. (2010) "Ecology Driving Genetic Variation: A Comparative Phylogeography of Jungle Cat (*Felis chaus*) and Leopard Cat (*Prionailurus bengalensis*) in India" [@mukherjee2010]

![Филогенетическое дерево из оригинальной статьи (Mukherjee et al., 2010). Дерево построено по мтДНК-последовательностям 55 особей болотной рыси (*Felis chaus*) и 40 леопардовых кошек (*Prionailurus bengalensis*) с использованием фрагментов генов NADH5 (303 п.н.) и цитохрома b (141 п.н.). В качестве внешней группы использована кошка-рыболов (*Prionailurus viverrinus*).](Phylogenetics_hw/images/mukherjee2010_tree.jpg){fig-align="center" width="700"}

## Объекты исследования

::::: columns
::: {.column width="50%"}
![Болотная рысь (*Felis chaus*), также известная как камышовый кот](Phylogenetics_hw/images/Jungle-Cat-Wild-Cat.jpg){fig-align="center" width="275"}
:::

::: {.column width="50%"}
![Леопардовая кошка (*Prionailurus bengalensis*), предок популярной породы бенгальских кошек](Phylogenetics_hw/images/bengal_cat.jpg){fig-align="center" width="273"}
:::
:::::

:::: columns
::: {.column width="50%"}
![Кошка-рыболов (*Prionailurus viverrinus*), использована в качестве внешней группы](Phylogenetics_hw/images/fishing-cat-in-the-water.jpg){fig-align="center" width="277"}
:::
::::

## Подготовка метаданных

Метаданные были получены из дополнительных материалов статьи с добавлением информации по внешней группе (*Prionailurus viverrinus*) из базы данных NCBI.

### Поиск последовательностей для внешней группы

```{bash}
#| eval: false
# Поиск и извлечение информации о последовательностях кошки-рыболова
(echo -e "AccessionVersion\tGi\tTitle\tOrganism\tTaxId\tSlen\tMolType\tTopology\tBiomol\tCreateDate"
esearch -db nucleotide -query "Prionailurus viverrinus and (cytb or NADH5) not predicted" | \
efetch -format docsum | \
xtract -pattern DocumentSummary \
  -element AccessionVersion Gi \
  -element Title \
  -element Organism TaxId \
  -element Slen MolType Topology Biomol \
  -element CreateDate) | column -t -s $'\t' | sort -k4
```

Для анализа были выбраны: - **JN811043.1** (611 п.н.) для гена NADH5 - **JN811056.1** (800 п.н.) для гена цитохрома b

### Структура метаданных

```{bash}
# Просмотр структуры файла метаданных
head Phylogenetics_hw/metadata.tsv | column -t -s $'\t' 
```

```{python}
# Анализ состава выборки по видам
import pandas as pd
meta = pd.read_csv('Phylogenetics_hw/metadata.tsv', sep='\t')
print("Распределение по видам:")
print(meta.Species.value_counts())
```

```{python}
# Географическое распределение образцов
print("\nРаспределение по биогеографическим зонам:")
print(meta.Biogeographic_zone.value_counts())
```

## Загрузка последовательностей из NCBI

Последовательности двух генов были загружены отдельно для последующего объединенного анализа.

```{bash}
#| eval: false
# Загрузка последовательностей цитохрома b и NADH5
> Phylogenetics_hw/cytb_sequences.fasta
> Phylogenetics_hw/NADH5_sequences.fasta

tail -n +2 metadata.tsv | \
while IFS=$'\t' read -r line; do
    IFS=$'\t' read -ra cols <<< "$line"
    
    NADH5_acc=${cols[1]}
    cytb_acc=${cols[2]}
    
    [ -z "$cytb_acc" ] && continue
    
    echo "Загрузка последовательностей: $NADH5_acc (NADH5) и $cytb_acc (cytb)"
    
    efetch -db nucleotide -id "$cytb_acc" -format fasta >> Phylogenetics_hw/cytb_sequences.fasta
    echo '' >> Phylogenetics_hw/cytb_sequences.fasta
    
    efetch -db nucleotide -id "$NADH5_acc" -format fasta >> Phylogenetics_hw/NADH5_sequences.fasta
    echo '' >> Phylogenetics_hw/NADH5_sequences.fasta
done
```

## Множественное выравнивание

Для каждого гена было выполнено независимое выравнивание с использованием MAFFT.

```{bash}
#| eval: false
# Множественное выравнивание последовательностей
mafft --auto --thread -1 Phylogenetics_hw/cytb_sequences.fasta > Phylogenetics_hw/cytb_sequences.align.fasta 
mafft --auto --thread -1 Phylogenetics_hw/NADH5_sequences.fasta > Phylogenetics_hw/NADH5_sequences.align.fasta 
```

::::: columns
::: {.column width="50%"}
![Визуализация выравнивания цитохрома b в Ugene](Phylogenetics_hw/images/CYTB_UGENE.png){fig-align="center"}
:::

::: {.column width="50%"}
![Визуализация выравнивания NADH5 в Ugene](Phylogenetics_hw/images/NADH5_UGENE.png){fig-align="center"}
:::
:::::

### Обрезка неинформативных участков

Для удаления плохо выровненных концевых регионов использовалась программа BMGE.

```{bash}
# Обрезка выравниваний
BMGE -i Phylogenetics_hw/cytb_sequences.align.fasta -t AA -m BLOSUM30 -of Phylogenetics_hw/cytb_sequences.align.trim.fasta 
BMGE -i Phylogenetics_hw/NADH5_sequences.align.fasta -t AA -m BLOSUM30 -of Phylogenetics_hw/NADH5_sequences.align.trim.fasta 
```

**Результат:** получены выравнивания длиной, сопоставимой с оригинальным исследованием (303 п.н. для NADH5, 141 п.н. для cytb).

## Конкатенация последовательностей

Для филогенетического анализа последовательности двух генов были объединены.

```{bash}
#| eval: false
# Объединение последовательностей двух генов
mkdir -p Phylogenetics_hw/tree_files

# Извлечение заголовков
grep "^>" Phylogenetics_hw/cytb_sequences.align.trim.fasta | cut -d' ' -f1 > Phylogenetics_hw/headers.txt

# Извлечение и объединение последовательностей
grep -v "^>" Phylogenetics_hw/cytb_sequences.align.trim.fasta > Phylogenetics_hw/cytb_seqs.txt
grep -v "^>" Phylogenetics_hw/NADH5_sequences.align.trim.fasta > Phylogenetics_hw/nadh5_seqs.txt
paste Phylogenetics_hw/cytb_seqs.txt nadh5_seqs.txt | tr -d '\t' > Phylogenetics_hw/sequences.txt

# Создание финального файла
paste -d '\n' Phylogenetics_hw/headers.txt Phylogenetics_hw/sequences.txt > Phylogenetics_hw/tree_files/concatenated_sequences.fasta

# Очистка временных файлов
rm Phylogenetics_hw/headers.txt Phylogenetics_hw/cytb_seqs.txt Phylogenetics_hw/nadh5_seqs.txt Phylogenetics_hw/sequences.txt
```

## Построение филогенетического дерева

Филогенетический анализ выполнен с использованием IQ-TREE с оценкой поддержки узлов.

```{bash}
#| eval: false
# Построение дерева максимального правдоподобия
cd Phylogenetics_hw/tree_files
iqtree -m TEST -s concatenated_sequences.fasta -bb 1000 -alrt 1000 -pre Cats_tree -redo 
cd -
```

## Визуализация и аннотация дерева

Для визуализации дерева в iTOL были подготовлены файлы аннотаций.

```{python}
#| eval: false
import pandas as pd
import matplotlib.cm as cm
import matplotlib.colors as mcolors
from Bio import Phylo

# Загрузка данных
meta = pd.read_csv('Phylogenetics_hw/metadata.tsv', sep='\t')
tree = Phylo.read('Phylogenetics_hw/tree_files/Cats_tree.treefile', 'newick')
tips = [t.name for t in tree.get_terminals()]

# Назначение цветов по биогеографическим зонам
states = meta['Biogeographic_zone'].unique()
cmap = cm.get_cmap('tab20')
state_to_color = dict(zip(states, [mcolors.rgb2hex(cmap(i)) for i in range(len(states))]))
meta['color'] = meta['Biogeographic_zone'].map(state_to_color)

# Подготовка словарей для аннотаций
meta['specie_id'] = meta['Species'] + '_' + meta['ID'].astype(str)
acc_clean = meta['Acc_Cyt_b'].str.split('.').str[0].str.strip()

tip_to_label = dict(zip(acc_clean, meta['specie_id']))
tip_to_color = dict(zip(acc_clean, meta['color']))

# Файл читаемых меток
with open('Phylogenetics_hw/tree_files/labels.txt', 'w') as f:
    f.write('LABELS\nSEPARATOR COMMA\nDATA\n')
    for tip in tips:
        clean_tip = tip.split('.')[0]
        f.write(f"{tip},{tip_to_label.get(clean_tip, tip)}\n")

# Файл цветов фона меток
with open('Phylogenetics_hw/tree_files/color_labels.txt', 'w') as f:
    f.write('TREE_COLORS\nSEPARATOR COMMA\nDATA\n')
    for tip in tips:
        clean_tip = tip.split('.')[0]
        f.write(f"{tip},label_background,{tip_to_color.get(clean_tip, '#CCCCCC')}\n")

# Цветовая полоса по биогеографическим зонам
unique_states = meta[['Biogeographic_zone', 'color']].drop_duplicates()
with open('Phylogenetics_hw/tree_files/colorstrip_groups.txt', 'w') as f:
    f.write(f"""DATASET_COLORSTRIP
SEPARATOR COMMA
DATASET_LABEL,Biogeographic zones
COLOR,#000000
LEGEND_TITLE,Biogeographic Zone
LEGEND_SHAPES,{",".join(["1"]*len(unique_states))}
LEGEND_COLORS,{",".join(unique_states["color"])}
LEGEND_LABELS,{",".join(unique_states["Biogeographic_zone"])}
DATA
""")
    for tip in tips:
        clean_tip = tip.split('.')[0]
        f.write(f"{tip},{tip_to_color.get(clean_tip, '#CCCCCC')}\n")

```

## Результаты

### Визуализация филогенетического дерева

![Общий вид филогенетического дерева](Phylogenetics_hw/images/tree_full.png){fig-align="center" width="491"}

### Основные выводы

1.  **Видовое разделение:** Леопардовые кошки (*Prionailurus bengalensis*) образуют четко отделенный кластер от болотных рысей (*Felis chaus*), что подтверждает, что подтверждает их различия

2.  **Географический паттерн:** Особи леопардовых кошек демонстрируют более выраженную географическую структуру по сравнению с болотными рысями, что может указывать на различия в истории популяций и расселении.

3.  **Статистическая поддержка:** Высокие значения бутстреп-поддержки (\>75%) для большинства узлов свидетельствуют о надежности полученной топологии дерева.

------------------------------------------------------------------------

**Выполнила:** Флоренская Лидия