---
engine: knitr
author: "Анна Сергеевна Попенко, к.б.н."
---


# Филогенетические деревья

## Типы деревьев

Укорененные/неукорененные (надо проверять, какое именно дерево строит программа - бывает, что она произвольно вставляет корень); ультраметрические/аддитивные

## Базовые понятия

-   Листья
-   Внутренние узлы (это зачастую гипотетические предки)
-   Корень (гипотетические прародитель всех)
-   Ветви
-   Клады (группы листьев, объединенные внутренним узлом)

## Источники данных для построения деревьев

1)  Множественное выравнивание
2)  Матрица расстояний
3)  Дерево

### Множественное выравнивание

-   Последовательности должны быть родственными, ортологи
-   Очистка (бывают вставки, которые стоит удалить)

### Эволюционнные модели: ДНК

1)  Jukes-Cantor

-   Все замены равновероятны
-   Частоты нуклеотидов - тоже равные
-   Испоользуется для коротких эволюционных расстояний (например подходит для вирусов)

2)  Kimura

-   Различает транзиции и трансверсии
-   Транзиции происходят чаще

![Транзиции и трансверсии](%D0%A1%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D1%8B_%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/03.12.25/%D0%A2%D1%80%D0%B0%D0%BD%D0%B7%D1%86%D0%B8%D0%B8_%D0%B8_%D1%82%D1%80%D0%B0%D0%BD%D1%81%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8.png){fig-align="center" width="225"}

3)  Hasegava-Kishino-Yano

-   Для ML - филогенетики
-   Как Кимура + учитываются неравные частоты нуклеотидов

4)  General Time Reversible

### Эволюционнные модели: Белок

1)  PAM
2)  BLOSUM
3)  LG (стандарт в IQ-TREE, PhyLM, RAxML)
4)  Строится на огромном наборе белковых MSA

### Матрица расстояний

Каждый элемент - эволюционная дистанция между двумя объектами

-   Неотрицательность
-   Симметричность
-   $d_{ii}$ = 0

#### Методы подсчета

1)  p-distance (proportion distance) $d_{ij} = \frac{число~ различий}{общая~ длина ~сравнения}$
2)  ML - посчитать t, при котором вероятность реализованного исхода наибольшая ...

### Построение дерева

#### Neighbor-Joining (NJ)

Метод ближайшего соседа

В начальной точке все последовательности равноудалены, алгоритм начинает с пары с минимальным расстоянием, к ней присоединяется следующая по минимальному расстоянию, строится неукорененное дерево (ведь мы начинаем с листьев)

Не требует равных скоростей эволюции

[Топология дерево сильно зависит от того, откуда мы начнем его строить]{.mark}

#### Maximum Parsimony

Наиболее вероятным считается дерево, требующее минимального числа эволюционных изменений

L(T) - длина дерева T = argmin(L(T))

Есть несколько алгоритмов подсчета длин деревьев, без полного перебора

Предполагает одинаковую скорость эволюции

Строит неукорененное дерево

#### UPGMA (Unweight Pair Group Method with Arithmetic Mean)

Одинаковая скорость эволюции + есть корень -\> строит укорененное, ультраметрическое дерево

#### Maximum Likelyhood

$T^*,~ \theta^* = arg~ max L(T,\theta~|MSA )$

Начальноу дерево -\> Оценить длину дерева -\> Есть улучшения? -\> и тд

#### Сравнение всех методов

![Alt text](Структуры_данных/03.12.25/%D0%A1%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D0%BE%D0%B2%20%D0%BF%D0%BE%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%B4%D0%B5%D1%80%D0%B5%D0%B2%D1%8C%D0%B5%D0%B2.png)

## Форматы дереьев

-   Newick (bootstrap - проверка дерева на устойчивость - если убрать лист - изменится ли топология клады) ((A:0.1,B:0.2)90:0.3,C:0.4)
-   Nexus Begin tree; Tree T1 = ((A,B),C); End;

Основан на блоках кода - XML - based (PHYLOXML) - JSON-based (Nextstrain)

## Визуализация

-   iTOL
-   Dendroscope
-   Auspice (для эпидемиологического анализа)
-   MEGA (хороша для обучения)
-   UGEN

# Практика филогенетические деревья

## Устанваливаем пакеты bmge, iqtree, emboss, phylip

```{bash}
#| eval: false
conda activate py3_study
conda install -c bioconda bmge -y
conda install -c bioconda -c conda-forge iqtree emboss phylip -y
```

## Строим множественное выравнивание

```{bash}
muscle -align Структуры_данных/03.12.25/seqs.fasta -output Структуры_данных/03.12.25/seqs.aln.fasta
```

Смотрим в UGENE и видим, что качество не очень высокое

![UGENE for aligned](Структуры_данных/03.12.25/UGENE%20for%20aligned.png) \## Чистим выравнивание от "плохих" позиций

```{bash}
BMGE -i Структуры_данных/03.12.25/seqs.aln.fasta -t AA -m BLOSUM30 -h 0.5 -of Структуры_данных/03.12.25/seqs.aln.trimmed.fasta
```

И снова посмотрим в UGENE

![Trimmed alignment](Структуры_данных/03.12.25/UGENE%20for%20trimmed%20alignes.png)

Программа аккуратно вырезала неудачные участки выравнивания

## Подсчет расстояний для NJ и UPGMA

### FASTA -\> PHYLIP + переименовываем

```{bash}
seqret -sequence Структуры_данных/03.12.25/seqs.aln.trimmed.fasta -outseq Структуры_данных/03.12.25/seqs.phy -osformat2 phylip
```

```{bash}
head Структуры_данных/03.12.25/seqs.phy
```

PHYLIP-программы по умолчанию читают файл "infile"

```{bash}
cp Структуры_данных/03.12.25/seqs.phy Структуры_данных/03.12.25/infile
```

## Запускаем protdist с настройками по умолчанию

```{bash}
cd Структуры_данных/03.12.25
protdist << EOF
Y

cd -
```

## Сохраняем матрицу расстояний в отдельный файл

```{bash}
mv Структуры_данных/03.12.25/outfile Структуры_данных/03.12.25/seqs.protdist
```

## NJ

Исходные данные для neighbor должны называться infile

```{bash}
cp Структуры_данных/03.12.25/seqs.protdist Структуры_данных/03.12.25/infile
```

```{bash}
cd Структуры_данных/03.12.25
neighbor << EOF
Y
EOF
cd -
```

```{bash}
mv Структуры_данных/03.12.25/outtree Структуры_данных/03.12.25/seqs.NJ.tree
mv Структуры_данных/03.12.25/outfile Структуры_данных/03.12.25/seqs.NJ.log
```

Дерево в Newick-формате:

```{bash}
head Структуры_данных/03.12.25/seqs.NJ.tree
```

Файл с простой визуализацией

```{bash}
head -50 Структуры_данных/03.12.25/seqs.NJ.log
```

[remember: this is an unrooted tree!]{.mark}

## UPGMA

```{bash}
cd Структуры_данных/03.12.25
neighbor << EOF
N
Y
EOF
cd -
```

```{bash}
mv Структуры_данных/03.12.25/outtree Структуры_данных/03.12.25/seqs.UPGMA.tree
mv Структуры_данных/03.12.25/outfile Структуры_данных/03.12.25/seqs.UPGMA.log
```

```{bash}
head -50 Структуры_данных/03.12.25/seqs.UPGMA.log
```

Можем сравнить деревья в Sublime Text

![Comparison](Структуры_данных/03.12.25/Comparison%20of%20UGENE%20and%20NJ%20trees.png){fig-align="center" width="399"}

```{bash}
head Структуры_данных/03.12.25/seqs.UPGMA.tree
```

## ML

```{bash}
#| eval: false
iqtree -s Структуры_данных/03.12.25/seqs.aln.trimmed.fasta --seqtype AA -m MFP -bb 1000 -nt AUTO
```

NEWICK

```{bash}
head Структуры_данных/03.12.25/seqs.aln.trimmed.fasta.treefile
```

NEXUS

```{bash}
head -50 Структуры_данных/03.12.25/seqs.aln.trimmed.fasta.splits.nex
```

Лучшее и консенсуснное дерево:

```{bash}
tail -150 Структуры_данных/03.12.25/seqs.aln.trimmed.fasta.iqtree
```

Появились bootstrepы

`conda deactivate`

## Визуализация на сайте Itools

Можем добавить метаданные - нужно создать новый датасет и вручную вставить данные из файла с метаданными, например

0 - не патоген, 1 - патоген.

```{bash}
head Структуры_данных/03.12.25/path.txt
```

![Dataset in Itools](Структуры_данных/03.12.25/Itools.png){fig-align="center" width="369"}

![Result](Структуры_данных/03.12.25/Itool-tree.png){fig-align="center" width="246"}